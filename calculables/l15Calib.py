
#
# Most of this implementation is lifted from the one by M. Tamsett
#
from math import cosh,log,log10

AntiKt4TopoJets_EM_JES_factors = [
## from https://svnweb.cern.ch/trac/atlasoff/browser/Reconstruction/Jet/JetCalibTools/tags/JetCalibTools-00-01-35/CalibConstants/EtaMassEnergyFactors.py
  [  -2.7855e-01,  1.9439e-01, -7.5202e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  0 -4.5<eta<-4.4
  [  -2.1306e-01,  1.8766e-01, -7.5752e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  1 -4.4<eta<-4.3
  [  -2.5014e-01,  1.9601e-01, -7.7835e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  2 -4.3<eta<-4.2
  [  -3.1817e-01,  2.1352e-01, -8.8695e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  3 -4.2<eta<-4.1
  [  -2.3209e-01,  1.9345e-01, -7.9713e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  4 -4.1<eta<-4.0
  [  -2.2182e-01,  1.9231e-01, -8.0497e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  5 -4.0<eta<-3.9
  [  -2.7253e-01,  2.0673e-01, -8.7223e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  6 -3.9<eta<-3.8
  [  -2.3787e+00,  1.0859e+00, -1.2629e-01,  5.0485e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  7 -3.8<eta<-3.7
  [  -3.8308e-01,  2.9595e-01, -2.3967e-02,  7.7065e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  8 -3.7<eta<-3.6
  [  -1.7146e+00,  8.4931e-01, -9.7219e-02,  3.8455e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin  9 -3.6<eta<-3.5
  [  -1.4660e-01,  1.7762e-01, -7.3193e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 10 -3.5<eta<-3.4
  [   1.2203e-01,  8.9756e-02, -2.7073e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 11 -3.4<eta<-3.3
  [   1.6030e-01,  7.5539e-02, -2.2199e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 12 -3.3<eta<-3.2
  [  -2.7670e-01,  2.4045e-01, -2.0661e-02,  7.7393e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 13 -3.2<eta<-3.1
  [  -5.2396e-01,  3.5673e-01, -3.2983e-02,  1.0911e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 14 -3.1<eta<-3.0
  [  -4.1346e-01,  3.5894e-01, -3.6665e-02,  1.3597e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 15 -3.0<eta<-2.9
  [  -2.1821e-01,  3.1140e-01, -3.3667e-02,  1.4019e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 16 -2.9<eta<-2.8
  [  -3.5120e-01,  3.4326e-01, -3.3982e-02,  1.1946e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 17 -2.8<eta<-2.7
  [  -2.9994e-01,  3.1626e-01, -2.9146e-02,  9.3647e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 18 -2.7<eta<-2.6
  [  -3.6469e-01,  3.5218e-01, -3.5476e-02,  1.2660e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 19 -2.6<eta<-2.5
  [  -2.7813e-01,  3.1212e-01, -2.9258e-02,  9.8385e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 20 -2.5<eta<-2.4
  [  -3.5056e-01,  3.4782e-01, -3.4015e-02,  1.1947e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 21 -2.4<eta<-2.3
  [  -2.7531e-01,  3.2404e-01, -3.1481e-02,  1.1090e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 22 -2.3<eta<-2.2
  [  -7.5462e-02,  2.4127e-01, -2.0083e-02,  5.9473e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 23 -2.2<eta<-2.1
  [  -4.0436e-02,  2.2520e-01, -1.7101e-02,  3.9692e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 24 -2.1<eta<-2.0
  [   4.0090e-01, -7.4295e-02,  5.8312e-02, -7.8844e-03,  3.3474e-04,  0.0000e+00,  0.0000e+00 ], ## bin 25 -2.0<eta<-1.9
  [   1.7426e-01,  7.0177e-02,  2.4366e-02, -4.4116e-03,  2.0541e-04,  0.0000e+00,  0.0000e+00 ], ## bin 26 -1.9<eta<-1.8
  [   4.8987e-01, -1.6987e-01,  8.9121e-02, -1.1933e-02,  5.2480e-04,  0.0000e+00,  0.0000e+00 ], ## bin 27 -1.8<eta<-1.7
  [   2.6746e-01, -1.4181e-02,  4.8234e-02, -7.3884e-03,  3.4147e-04,  0.0000e+00,  0.0000e+00 ], ## bin 28 -1.7<eta<-1.6
  [   3.4681e-01, -7.4317e-02,  6.2415e-02, -8.9160e-03,  4.0350e-04,  0.0000e+00,  0.0000e+00 ], ## bin 29 -1.6<eta<-1.5
  [   2.2181e-01,  3.8535e-02,  2.5941e-02, -4.4396e-03,  2.1149e-04,  0.0000e+00,  0.0000e+00 ], ## bin 30 -1.5<eta<-1.4
  [   8.3640e-02,  1.5324e-01, -7.5277e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 31 -1.4<eta<-1.3
  [   3.1004e-01, -2.1619e-02,  4.6087e-02, -6.7398e-03,  3.0117e-04,  0.0000e+00,  0.0000e+00 ], ## bin 32 -1.3<eta<-1.2
  [   3.1926e-01, -3.0356e-02,  5.0632e-02, -7.3867e-03,  3.3130e-04,  0.0000e+00,  0.0000e+00 ], ## bin 33 -1.2<eta<-1.1
  [   3.0134e-01, -2.3137e-03,  4.0834e-02, -6.1881e-03,  2.8053e-04,  0.0000e+00,  0.0000e+00 ], ## bin 34 -1.1<eta<-1.0
  [   1.1882e-01,  1.4813e-01, -1.4743e-03, -1.4522e-03,  8.8070e-05,  0.0000e+00,  0.0000e+00 ], ## bin 35 -1.0<eta<-0.9
  [   1.6481e-01,  1.2384e-01,  4.0777e-03, -1.9889e-03,  1.0603e-04,  0.0000e+00,  0.0000e+00 ], ## bin 36 -0.9<eta<-0.8
  [   1.2307e-01,  1.7893e-01, -1.3414e-02,  2.8851e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 37 -0.8<eta<-0.7
  [   1.8751e-01,  1.4390e-01, -3.6558e-03, -9.1741e-04,  5.4285e-05,  0.0000e+00,  0.0000e+00 ], ## bin 38 -0.7<eta<-0.6
  [   1.7410e-01,  1.7400e-01, -1.3652e-02,  3.1985e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 39 -0.6<eta<-0.5
  [   2.1197e-01,  1.5820e-01, -1.1063e-02,  1.7000e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 40 -0.5<eta<-0.4
  [   1.2825e-01,  2.2113e-01, -2.8096e-02,  2.1542e-03, -8.5015e-05,  0.0000e+00,  0.0000e+00 ], ## bin 41 -0.4<eta<-0.3
  [   3.6267e-02,  2.6531e-01, -3.5879e-02,  2.7357e-03, -9.9874e-05,  0.0000e+00,  0.0000e+00 ], ## bin 42 -0.3<eta<-0.2
  [   3.7710e-02,  2.4940e-01, -2.9065e-02,  1.7147e-03, -4.8612e-05,  0.0000e+00,  0.0000e+00 ], ## bin 43 -0.2<eta<-0.1
  [   1.5751e-02,  2.6971e-01, -3.6066e-02,  2.6341e-03, -8.9832e-05,  0.0000e+00,  0.0000e+00 ], ## bin 44 -0.1<eta<-0.0
  [  -2.6115e-03,  2.8734e-01, -4.2097e-02,  3.4920e-03, -1.3371e-04,  0.0000e+00,  0.0000e+00 ], ## bin 45  0.0<eta< 0.1
  [  -2.0407e-02,  2.9803e-01, -4.3536e-02,  3.5423e-03, -1.3249e-04,  0.0000e+00,  0.0000e+00 ], ## bin 46  0.1<eta< 0.2
  [   1.1392e-02,  2.7868e-01, -3.8505e-02,  2.9457e-03, -1.0592e-04,  0.0000e+00,  0.0000e+00 ], ## bin 47  0.2<eta< 0.3
  [   1.7279e-01,  1.7883e-01, -1.4572e-02,  3.5104e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 48  0.3<eta< 0.4
  [   1.9097e-01,  1.6887e-01, -1.2925e-02,  2.7205e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 49  0.4<eta< 0.5
  [   1.6731e-01,  1.7531e-01, -1.3624e-02,  3.0253e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 50  0.5<eta< 0.6
  [   1.5643e-01,  1.6859e-01, -1.1436e-02,  1.5375e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 51  0.6<eta< 0.7
  [   2.0291e-01,  1.0959e-01,  7.3901e-03, -2.3541e-03,  1.2080e-04,  0.0000e+00,  0.0000e+00 ], ## bin 52  0.7<eta< 0.8
  [   1.9196e-01,  9.7868e-02,  1.2489e-02, -3.1437e-03,  1.6224e-04,  0.0000e+00,  0.0000e+00 ], ## bin 53  0.8<eta< 0.9
  [   2.0126e-01,  7.7369e-02,  1.9358e-02, -4.0297e-03,  2.0215e-04,  0.0000e+00,  0.0000e+00 ], ## bin 54  0.9<eta< 1.0
  [   2.9062e-01,  3.9852e-03,  3.9222e-02, -6.0018e-03,  2.7202e-04,  0.0000e+00,  0.0000e+00 ], ## bin 55  1.0<eta< 1.1
  [   3.1810e-01, -3.0149e-02,  5.0347e-02, -7.2846e-03,  3.2288e-04,  0.0000e+00,  0.0000e+00 ], ## bin 56  1.1<eta< 1.2
  [   3.0440e-01, -2.1208e-02,  4.6917e-02, -6.8951e-03,  3.0961e-04,  0.0000e+00,  0.0000e+00 ], ## bin 57  1.2<eta< 1.3
  [   3.4517e-01, -5.5615e-02,  5.3168e-02, -7.5101e-03,  3.3564e-04,  0.0000e+00,  0.0000e+00 ], ## bin 58  1.3<eta< 1.4
  [   2.4424e-01,  2.4112e-02,  2.9662e-02, -4.8635e-03,  2.2995e-04,  0.0000e+00,  0.0000e+00 ], ## bin 59  1.4<eta< 1.5
  [   3.2637e-01, -5.3006e-02,  5.5745e-02, -8.0683e-03,  3.6482e-04,  0.0000e+00,  0.0000e+00 ], ## bin 60  1.5<eta< 1.6
  [   4.2270e-01, -1.2450e-01,  7.7335e-02, -1.0717e-02,  4.8014e-04,  0.0000e+00,  0.0000e+00 ], ## bin 61  1.6<eta< 1.7
  [   6.0091e-01, -2.4934e-01,  1.1024e-01, -1.4370e-02,  6.2689e-04,  0.0000e+00,  0.0000e+00 ], ## bin 62  1.7<eta< 1.8
  [   4.1091e-01, -1.0585e-01,  7.1632e-02, -9.8298e-03,  4.2883e-04,  0.0000e+00,  0.0000e+00 ], ## bin 63  1.8<eta< 1.9
  [  -5.1845e-02,  2.3206e-01, -1.8171e-02,  4.5711e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 64  1.9<eta< 2.0
  [   2.9870e-01, -9.5431e-03,  4.3308e-02, -6.4368e-03,  2.8618e-04,  0.0000e+00,  0.0000e+00 ], ## bin 65  2.0<eta< 2.1
  [  -8.5927e-02,  2.4659e-01, -2.0820e-02,  6.1405e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 66  2.1<eta< 2.2
  [  -2.6623e-01,  3.1721e-01, -2.9925e-02,  9.9756e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 67  2.2<eta< 2.3
  [  -3.1490e-01,  3.3286e-01, -3.2079e-02,  1.1155e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 68  2.3<eta< 2.4
  [  -3.4784e-01,  3.5038e-01, -3.6297e-02,  1.4166e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 69  2.4<eta< 2.5
  [  -3.4057e-01,  3.4236e-01, -3.4333e-02,  1.2255e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 70  2.5<eta< 2.6
  [  -2.9434e-01,  3.1148e-01, -2.8258e-02,  8.7808e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 71  2.6<eta< 2.7
  [  -2.7815e-01,  3.0496e-01, -2.7759e-02,  8.6255e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 72  2.7<eta< 2.8
  [  -1.3330e-01,  2.5817e-01, -2.3191e-02,  7.3033e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 73  2.8<eta< 2.9
  [  -3.7478e-01,  3.4079e-01, -3.4123e-02,  1.2460e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 74  2.9<eta< 3.0
  [  -5.9595e-01,  3.9274e-01, -3.8773e-02,  1.3819e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 75  3.0<eta< 3.1
  [  -3.0432e-01,  2.5661e-01, -2.3543e-02,  9.3745e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 76  3.1<eta< 3.2
  [  -1.8337e-01,  2.4082e-01, -2.7720e-02,  1.2594e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 77  3.2<eta< 3.3
  [   2.0482e-01,  7.6866e-02, -2.9955e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 78  3.3<eta< 3.4
  [  -1.4981e-01,  1.7848e-01, -7.4684e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 79  3.4<eta< 3.5
  [  -1.9413e+00,  9.3072e-01, -1.0685e-01,  4.2260e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 80  3.5<eta< 3.6
  [  -4.3200e-01,  3.0246e-01, -2.3336e-02,  7.0504e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 81  3.6<eta< 3.7
  [  -2.1956e+00,  1.0119e+00, -1.1640e-01,  4.6100e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 82  3.7<eta< 3.8
  [  -4.1473e-01,  2.7855e-01, -2.0288e-02,  6.0849e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 83  3.8<eta< 3.9
  [  -5.0737e-01,  3.1654e-01, -2.6082e-02,  8.8348e-04,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 84  3.9<eta< 4.0
  [  -2.6086e-01,  2.0067e-01, -8.3743e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 85  4.0<eta< 4.1
  [  -1.9804e-01,  1.8833e-01, -7.8642e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 86  4.1<eta< 4.2
  [  -1.2029e-01,  1.6987e-01, -6.7732e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 87  4.2<eta< 4.3
  [  -2.7060e-01,  2.0012e-01, -8.1378e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ], ## bin 88  4.3<eta< 4.4
  [  -1.8805e-01,  1.7493e-01, -6.6962e-03,  0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00 ]  ## bin 89  4.4<eta< 4.5
]
L2FS_EM_residual_correction_factors_v1 = [
    [-3.22535e+00, 2.36117e+00, -5.89355e-01,  3.20848e-02,  9.59680e-03, -1.6180e-03, 7.3730e-05], ## bin  0 -4.9<eta<-4.0   
    [-2.42162e+00, 1.75498e+00, -4.95060e-01,  6.02290e-02, -2.61216e-03,  0.0000e+00, 0.0000e+00], ## bin  1 -4.0<eta<-3.2
    [-8.05172e-01, 2.78692e-01, -1.22120e-02, -5.20324e-03,  5.16293e-04,  0.0000e+00, 0.0000e+00], ## bin  2 -3.2<eta<-2.5     
    [-1.69015e+00, 1.05382e+00, -2.65796e-01,  3.10190e-02, -1.37606e-03,  0.0000e+00, 0.0000e+00], ## bin  3 -2.5<eta<-1.6  
    [-1.68114e+00, 1.00122e+00, -2.38191e-01,  2.51231e-02, -9.46365e-04,  0.0000e+00, 0.0000e+00], ## bin  4 -1.6<eta<-0.8 
    [-1.79174e+00, 1.15668e+00, -2.98094e-01,  3.53430e-02, -1.59241e-03,  0.0000e+00, 0.0000e+00], ## bin  5 -0.8<eta< 0
    [-1.79174e+00, 1.15668e+00, -2.98094e-01,  3.53430e-02, -1.59241e-03,  0.0000e+00, 0.0000e+00], ## bin  6  0  <eta< 0.8
    [-1.68114e+00, 1.00122e+00, -2.38191e-01,  2.51231e-02, -9.46365e-04,  0.0000e+00, 0.0000e+00], ## bin  7  0.8<eta< 1.6  
    [-1.69015e+00, 1.05382e+00, -2.65796e-01,  3.10190e-02, -1.37606e-03,  0.0000e+00, 0.0000e+00], ## bin  8  1.6<eta< 2.5   
    [-8.05172e-01, 2.78692e-01, -1.22120e-02, -5.20324e-03,  5.16293e-04,  0.0000e+00, 0.0000e+00], ## bin  9  2.5<eta< 3.2  
    [-1.64465e+00, 8.39845e-01, -1.56635e-01,  8.66195e-03,  1.97325e-04,  0.0000e+00, 0.0000e+00], ## bin 10  3.2<eta< 4.0  
    [-2.32498e+00, 1.63786e+00, -4.40221e-01,  5.21144e-02, -2.29390e-03,  0.0000e+00, 0.0000e+00], ## bin 11  4.0<eta< 4.9  
] ### first pass factors log(ET)

L2FS_EM_residual_correction_factors = [
    [-6.63469e-12, -8.33538e-11, -7.62306e-10, -2.11065e-01, -1.43299e-01, 0.0000e+00, 0.0000e+00], ## bin 0 -4.9< eta <-4.0  
    [-4.01794e-02, -1.15158e-01, -3.67560e-04, -2.35229e-03, -1.97009e-01, 0.0000e+00, 0.0000e+00], ## bin 1 -4.0< eta <-3.2        
    [-4.47860e-02,  1.91685e-01, -4.59624e-01,  0.0000e+00,   0.0000e+00 , 0.0000e+00, 0.0000e+00], ## bin 2 -3.2<eta -2.5
    [6.03751e-02,  -9.63390e-02, -3.05565e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 3  -2.5<eta<-1.6        
    [-8.89929e-03,  2.22643e-02, -3.83097e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 4 -1.6<eta<-0.8
    [5.73233e-02,  -5.45971e-02, -3.30586e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 5 -0.8<eta< 0
    [5.73233e-02,  -5.45971e-02, -3.30586e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 6  0.0<eta< 0.8
    [-8.89929e-03,  2.22643e-02, -3.83097e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 7  0.8<eta< 1.6
    [6.03751e-02,  -9.63390e-02, -3.05565e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 8  1.6<eta<2.5 
    [-4.47860e-02,  1.91685e-01, -4.59624e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 9  2.5<eta<3.2
    [1.07098e-01,  -3.60620e-01, -1.92259e-01,  0.0000e+00,   0.0000e+00,  0.0000e+00, 0.0000e+00], ## bin 10 3.2< eta <4        
    [-4.56861e-11, -1.15051e-10, -9.57368e-11, -2.97003e-01, -4.32565e-02, 0.0000e+00, 0.0000e+00], ## bin 11 4.0< eta<4.9   
] ### factors for reprocessing 1/log10(ET)


L2FS_em_residual_eta_bins = [-4.9, -4.0, -3.2, -2.5, -1.6, -0.8, 0.0, 0.8, 1.6, 2.5, 3.2, 4.0, 4.9]

def GetEtaBin_EMJES(eta):
    # 90 eta bins
    ieta=int(eta*10)+45
    if (eta<0): ieta-=1
    if ( ieta <  0 ): return 0
    if ( ieta > 89 ): return 89
    return ieta

def PolyLogE_EMJES(bin, energy):
    # up to 7 parameter for the pol-fit
    logE=log(energy)
    y=0
    for i in range(7): y += AntiKt4TopoJets_EM_JES_factors[bin][i]*pow(logE,i)
    return y

def GetEtaBin_Residual(eta):
    for i,i_eta in enumerate(L2FS_em_residual_eta_bins):
        if (eta < i_eta):
            return i-1
    if (eta < 0):  return 0 
    return len(L2FS_em_residual_eta_bins)-1

def PolyLogET_Residual(bin, transverse_energy):
    # up to 7 parameter for the pol-fit
    logE=1./log10(transverse_energy)
    y=0
    for i in range(7): y += L2FS_EM_residual_correction_factors[bin][i]*pow(logE,i)
    return y

def emResidualEtCorrFactor(jet) :
    """Correction factor accounting for the residual correction.
    To be applied to the jet E_T.
    """
    eta_bin = GetEtaBin_Residual(jet.eta)        
    calibration_factor = PolyLogET_Residual(eta_bin,jet.et)
    multiplicative_correction_factor = 1. / (1. + calibration_factor)
    return multiplicative_correction_factor

def emJesEnergyCorrFactor(jet) :
    """Correction factor accounting for the JES correction.
    To be applied to the jet energy.
    """
    energy = jet.et*cosh(jet.eta)    
    eta_bin = GetEtaBin_EMJES(jet.eta)
    calibration_factor = PolyLogE_EMJES(eta_bin,energy)        
    return 1./calibration_factor
